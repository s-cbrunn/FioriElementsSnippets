/*
 * ! OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["../../TableDelegate","../../util/loadModules","../../library","sap/m/ColumnPopoverSelectListItem","sap/m/MessageBox","sap/ui/core/Item","sap/ui/core/Core","sap/ui/core/library","sap/ui/core/format/ListFormat","sap/ui/base/ManagedObjectObserver"],function(T,l,a,C,M,I,b,c,L,d){"use strict";var f=a.TableType;var g=new window.WeakMap();var D=Object.assign({},T);D.fetchPropertyHelper=function(e,P,G){return l("sap/ui/mdc/table/V4AnalyticsPropertyHelper").then(function(R){return R[0];});};D.fetchPropertyExtensions=function(e,P){return Promise.resolve(null);};D.fetchPropertiesForBinding=function(e){return this.fetchProperties(e);};D.fetchPropertyExtensionsForBinding=function(e,P){return this.fetchPropertyExtensions(e,P);};D.formatGroupHeader=function(e,G,P){};D.preInit=function(e){if(!g.has(e)){g.set(e,{});}return v(e).then(function(){s(e);E(e);});};D.validateState=function(e,S,K){var G=T.validateState.apply(this,arguments);var V;var R=sap.ui.getCore().getLibraryResourceBundle("sap.ui.mdc");if(K=="Sort"&&S.sorters){if(!t(e,S.items,S.sorters)){V={validation:c.MessageType.Information,message:R.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION")};}}else if(K=="Group"&&S.aggregations){var H=Object.keys(S.aggregations);var J=[];var N=L.getInstance();H.forEach(function(P){if(e.getPropertyHelper().isGroupable(P)){J.push(P);}});if(J.length){V={validation:c.MessageType.Information,message:R.getText("table.PERSONALIZATION_DIALOG_GROUP_RESTRICTION",[N.format(J)])};}}else if(K=="Column"){var O;var H=S.aggregations&&Object.keys(S.aggregations);if(!t(e,S.items,H)){O=R.getText("table.PERSONALIZATION_DIALOG_TOTAL_RESTRICTION");}if(!t(e,S.items,S.sorters)){O=O?O+"\n"+R.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION"):R.getText("table.PERSONALIZATION_DIALOG_SORT_RESTRICTION");}if(O){V={validation:c.MessageType.Information,message:O};}}return u(G,V);};D.updateBinding=function(G,H,J){if(!J||J.hasPendingChanges()||J.getPath()!=H.path){this.rebindTable(G,H);return;}var R=J.getRootBinding();var K=R&&!R.isSuspended();try{if(K){R.suspend();}s(G,H);J.changeParameters(H.parameters);J.filter(H.filters,"Application");J.sort(H.sorter);}catch(e){this.rebindTable(G,H);if(R==J){K=false;}}finally{if(K&&R.isSuspended()){R.resume();}}};D.rebindTable=function(e,G){s(e,G);T.rebindTable(e,G);};D.addColumnMenuItems=function(e,G){if(!w(e)){return[];}var P=e.getPropertyHelper();var H=P.getGroupableProperties(G.getDataProperty());var J=P.getAggregatableProperties(G.getDataProperty());var K=e._oPopover;var N;var O;if(K){K.getItems().forEach(function(Q,R,S){var U=Q.getLabel();var V=b.getLibraryResourceBundle("sap.ui.mdc");if(U===V.getText("table.SETTINGS_GROUP")||U===V.getText("table.SETTINGS_TOTALS")){S[R].destroy();}if(S.length==0){K.destroy();}});}if(e.isGroupingEnabled()&&H&&H.length>0){O=h(H,G);}if(e.isAggregationEnabled()&&J&&J.length>0){N=i(J,G);}return[O,N];};function h(G,e){var H=G.map(function(J){return new I({text:J.getLabel(),key:J.getName()});});if(H.length>0){return new C({items:H,label:b.getLibraryResourceBundle("sap.ui.mdc").getText("table.SETTINGS_GROUP"),icon:"sap-icon://group-2",action:[{sName:"Group",oMDCColumn:e},j,this]});}}function i(e,G){var H=e.map(function(J){return new I({text:J.getLabel(),key:J.getName()});});if(H.length>0){return new C({items:H,label:b.getLibraryResourceBundle("sap.ui.mdc").getText("table.SETTINGS_TOTALS"),icon:"sap-icon://sum",action:[{sName:"Aggregate",oMDCColumn:G},j,this]});}}function j(e,G){var N=G.sName,H=G.oMDCColumn.getParent(),J=H.getCurrentState().groupLevels||[],K=H.getCurrentState().aggregations||{},O=Object.keys(K),P=false,Q=e.getParameter("property"),R=N==="Aggregate"?J:O,S=R.filter(function(Y){return N==="Aggregate"?Y.name===Q:Y===Q;}).length>0;if(S){var U=b.getLibraryResourceBundle("sap.ui.mdc");var V;var W;var X;if(N==="Aggregate"){V=U.getText("table.SETTINGS_WARNING_TITLE_TOTALS");W=U.getText("table.SETTINGS_MESSAGE2");X=U.getText("table.SETTINGS_WARNING_BUTTON_TOTALS");}else{V=U.getText("table.SETTINGS_WARNING_TITLE_GROUPS");W=U.getText("table.SETTINGS_MESSAGE1");X=U.getText("table.SETTINGS_WARNING_BUTTON_GROUP");}P=true;M.warning(W,{id:H.getId()+"-messageBox",title:V,actions:[X,U.getText("table.SETTINGS_WARNING_BUTTON_CANCEL")],onClose:function(Y){if(Y===X){k(N,H,Q);}}});}if(N==="Aggregate"&&!P){o(N,H,Q);}else if(N==="Group"&&!P){o(N,H,Q);}}function o(e,G,P){if(e==="Group"){G._onCustomGroup(P);}else{G._onCustomAggregate(P);}}function k(N,e,P){if(N==="Aggregate"){e._onCustomGroup(P);e._onCustomAggregate(P);}else if(N==="Group"){e._onCustomAggregate(P);e._onCustomGroup(P);}}function s(e,G){if(w(e)){var H=Object.keys(e._getAggregatedProperties());var S=G&&G.parameters["$search"]||undefined;if(S){delete G.parameters["$search"];}var J=e._getGroupedProperties().map(function(N){return N.name;});var K={visible:m(e),groupLevels:J,grandTotal:H,subtotals:H,columnState:n(e,H),search:S};g.get(e).plugin.setAggregationInfo(K);}}function m(e){var V=new Set();var P=g.get(e).oPropertyHelperForBinding;e.getColumns().forEach(function(G){var H=P.getProperty(G.getDataProperty());if(!H){return;}if(H.isComplex()){H.getReferencedProperties().forEach(function(H){V.add(H.name);});}else{V.add(H.name);}});return Array.from(V);}function n(e,G){var H={};e.getColumns().forEach(function(J){var K=J.getId()+"-innerColumn";var N=q(e,J,G);var O=N.length>0;if(K in H){H[K].subtotals=O||H[K].subtotals;H[K].grandTotal=O||H[K].grandTotal;return;}H[K]={subtotals:O,grandTotal:O};r(e,N).forEach(function(U){K=U.getId()+"-innerColumn";if(K in H){H[K].subtotals=O||H[K].subtotals;H[K].grandTotal=O||H[K].grandTotal;}else{H[K]={subtotals:O,grandTotal:O};}});});return H;}function p(e,G){var P=e.getPropertyHelper().getProperty(G.getDataProperty());if(!P){return[];}else if(P.isComplex()){return P.getReferencedProperties();}else{return[P];}}function q(e,G,H){return p(e,G).filter(function(P){return H.includes(P.name);});}function r(e,P){var U=[];P.forEach(function(G){var H=G?G.getUnitProperty():null;if(H){U.push(H);}});return e.getColumns().filter(function(G){return p(e,G).some(function(H){return U.includes(H);});});}function t(e,G,S){var P,H=[];G&&G.forEach(function(J){P=e.getPropertyHelper().getProperty(J.name);if(!P.isComplex()){H.push(P.name);}else{P.getReferencedProperties().forEach(function(R){H.push(R.name);});}});var O=S?S.every(function(J){return H.find(function(K){return J.name?J.name===K:J===K;});}):true;return O;}function u(e,V){var S={Error:1,Warning:2,Information:3,None:4};if(!V||S[V.validation]-S[e.validation]>0){return e;}else{return V;}}function v(e){return e._isOfType(f.Table)?x(e):A(e);}function w(e){if(e._isOfType(f.Table)){var P=g.get(e).plugin;return P!=null&&!P.bIsDestroyed;}else{return false;}}function x(e){return F(e)?y(e):z(e);}function y(e){var G=g.get(e);var P=G.plugin;if(P&&!P.bIsDestroyed){P.activate();return Promise.resolve();}return Promise.all([e.awaitPropertyHelper(),l("sap/ui/table/plugins/V4Aggregation")]).then(function(R){var V=R[1][0];var H=e.getControlDelegate();P=new V({groupHeaderFormatter:function(J,K){return H.formatGroupHeader(e,J,K);}});e._oTable.addDependent(P);G.plugin=P;return B(e);}).then(function(H){P.setPropertyInfos(H.getProperties());});}function z(e){var G=g.get(e);if(G.plugin){G.plugin.deactivate();}return Promise.resolve();}function A(e){return Promise.resolve();}function B(e){var G=g.get(e);if(G.oPropertyHelperForBinding){return Promise.resolve(G.oPropertyHelperForBinding);}var H=e.getControlDelegate();var P;var J;return H.fetchPropertiesForBinding(e).then(function(K){P=K;return H.fetchPropertyExtensionsForBinding(e,P);}).then(function(K){J=K;return H.fetchPropertyHelper(e,P,J);}).then(function(K){var N=K.constructor===K;G.oPropertyHelperForBinding=N?K:new K(P,J,e);return G.oPropertyHelperForBinding;});}function E(e){var G=g.get(e);if(!G.observer){G.observer=new d(function(H){if(H.type==="destroy"){if(G.oPropertyHelperForBinding){G.oPropertyHelperForBinding.destroy();}}else{v(e);}});}G.observer.observe(e,{properties:["p13nMode"],destroy:true});}function F(e){return e.isGroupingEnabled()||e.isAggregationEnabled();}return D;});
