/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/each","sap/base/util/isPlainObject","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Core","sap/ui/fl/apply/_internal/changes/Utils","sap/ui/fl/write/_internal/condenser/classifications/LastOneWins","sap/ui/fl/write/_internal/condenser/classifications/Reverse","sap/ui/fl/write/_internal/condenser/UIReconstruction","sap/ui/fl/write/_internal/condenser/Utils","sap/ui/fl/Change","sap/ui/fl/Utils","sap/ui/performance/Measurement"],function(e,i,J,C,c,L,R,U,d,f,F,M){"use strict";var g={};var h="unclassified";var N={lastOneWins:L,reverse:R};function j(S,a){var b=S[sap.ui.fl.condenser.Classification.Move];return a.classification===sap.ui.fl.condenser.Classification.Create&&b&&b[b.length-1].targetContainer===a.targetContainer;}function k(S,a){return a.classification===sap.ui.fl.condenser.Classification.Move&&S[sap.ui.fl.condenser.Classification.Destroy];}function l(a,b){return b.classification===sap.ui.fl.condenser.Classification.Create&&a[sap.ui.fl.condenser.Classification.Destroy];}function m(a,b,B,D){if(!k(a,B)&&!l(a,B)){var E=B.classification;if(!a[E]){B.change=D;a[E]=[B];}}if(j(a,B)||l(a,B)){delete a[sap.ui.fl.condenser.Classification.Move];delete a[sap.ui.fl.condenser.Classification.Destroy];}U.addChange(b,B);}function n(T,a,I,b,B){if(!T[b.type]){T[b.type]={};}var D=T[b.type];if(b.type===d.NOT_INDEX_RELEVANT){if(!D[b.classification]){D[b.classification]={};}var P=D[b.classification];N[b.classification].addToChangesMap(P,b.uniqueKey,B);}else{I.push(B);m(D,a,b,B);}}function o(T,K,a){if(!T[K]){T[K]=[];}T[K].push(a);}function p(a,b){var B=J.getControlIdBySelector(b.getSelector(),a);var D=C.byId(B);if(D){var P={modifier:J,appComponent:a,view:F.getViewForControl(D)};var E=c.getControlIfTemplateAffected(b,D,P);return Promise.resolve(c.getChangeHandler(b,E,P)).then(function(G){if(G&&typeof G.getCondenserInfo==="function"){return G.getCondenserInfo(b);}});}return Promise.resolve();}function q(a,b,B,D){var E=b!==undefined?b.affectedControl:J.getControlIdBySelector(B.getSelector(),D);if(!a[E]){a[E]={};}return a[E];}function r(a,b,B,I,D){return D.reduce(function(P,E){return P.then(s.bind(this,a,b,B,I,E));}.bind(this),Promise.resolve());}function s(a,b,B,I,D){return p(a,D).then(function(E){u(E,a);var T=q(b,E,D,a);if(E!==undefined){t(E);n(T,B,I,E,D);}else{o(T,h,D);b[h]=true;}});}function t(a){if(N[a.classification]){a.type=d.NOT_INDEX_RELEVANT;}else{a.type=d.INDEX_RELEVANT;}}function u(a,b){["affectedControl","sourceContainer","targetContainer"].forEach(function(P){if(a&&a[P]){a[P]=J.getControlIdBySelector(a[P],b);}});}function v(O,a){e(O,function(K,S){if(N[K]&&N[K].getChangesFromMap){N[K].getChangesFromMap(O,K).forEach(function(b){a.push(b);});}else if(i(S)){return v(S,a);}else if(Array.isArray(S)){S.forEach(function(b){if(b instanceof f){a.push(b);}else{a.push(b.change);}});}});return a;}function w(a){return v(a,[]);}function x(a,b){e(a,function(K,S){if(i(S)){x(S,b);}else if(Array.isArray(S)){S.forEach(function(O){if(!(O instanceof f)){b.push(O);}});}});return b;}function y(B,D){D.sort(function(a,b){return B.indexOf(a)-B.indexOf(b);});}function z(B,D){D.sort(function(a,b){return B.indexOf(a.change)-B.indexOf(b.change);});}function A(a,I){var b=a.map(function(B){return B.getId();});I.forEach(function(B){if(b.indexOf(B.getId())===-1){a.push(B);}});}g.condense=function(a,b){M.start("Condenser_overall","Condenser overall - CondenserClass",["sap.ui.fl","Condenser"]);var B={};var D={};var E=[];var G=[];var H=[];b.slice(0).reverse().forEach(function(I){if(I instanceof f&&I.isApplyProcessFinished()){H.push(I);}else{G.push(I);}});M.start("Condenser_defineMaps","defining of maps - CondenserClass",["sap.ui.fl","Condenser"]);return r(a,B,D,E,H).then(function(){M.end("Condenser_defineMaps");var I=B[h];if(!I){U.compareAndUpdate(B,D);}var K=w(B);if(I){A(K,E);}K=K.concat(G);y(b,K);if(!I){M.start("Condenser_handleIndexRelatedChanges","handle index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var O=x(B,[]);z(b,O);M.start("Condenser_sort","sort index related changes - CondenserClass",["sap.ui.fl","Condenser"]);var P=U.sortIndexRelatedChanges(D,O);M.end("Condenser_sort");U.swapChanges(P,K);M.end("Condenser_handleIndexRelatedChanges");}M.end("Condenser_overall");return K;});};return g;});
