/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/base/util/restricted/_isEqual","sap/base/util/each","sap/ui/fl/write/_internal/condenser/classifications/Create","sap/ui/fl/write/_internal/condenser/classifications/Destroy","sap/ui/fl/write/_internal/condenser/classifications/Move","sap/ui/fl/write/_internal/condenser/Utils"],function(_,e,C,D,M,U){"use strict";var d={};var I={create:C,destroy:D,move:M};function f(a,c){e(a,function(O,b){e(b,function(q,r){c(b,O,r,q);});});}function s(E,O,N){E.splice(N,0,E.splice(O,1)[0]);}function g(a,c){var b={};f(a,function(q,r,t,A){var T=t[U.TARGET_UI];T.forEach(function(v){c.forEach(function(w){if(v===w.affectedControl){if(!b[r]){b[r]={};}var x=b[r];if(!x[A]){x[A]=[];}var y=x[A];y.push(w);}});});});return b;}function h(c){return!c.some(function(E){return E.classification!==sap.ui.fl.condenser.Classification.Create;});}function i(E){return!E.some(function(v){return U.isUnknown(v);});}function j(c){return c.getTargetIndex(c.change);}function k(c){c.sort(function(a,b){var q=j(a);var N=j(b);return q-N;});}function l(E){return!E.some(function(v){return!U.isUnknown(v);});}function m(a,b){var c;if(a.length<b.length){c=b.slice(a.length);if(!l(c)){return false;}b=b.slice(0,a.length);}else if(a.length>b.length){c=a.slice(b.length,a.length);if(!l(c)){return false;}a=a.slice(0,b.length);}return _(a,b);}function n(c,a,b,t,q){var r={};q.forEach(function(v){var c=v.targetContainer;if(!r[c]){r[c]={};}var w=r[c];if(!w[a]){w[a]=U.initializeArrayWithPlaceholders(0,b.length-1);}I[v.classification].simulate(w[a],v,b);});var S=r[c][a];if(m(t,S)){return true;}return false;}function u(r,a){f(a,function(b,c,q){q[U.TARGET_UI].forEach(function(t,v){if(!U.isUnknown(t)){var T=r[t];var S=T[U.INDEX_RELEVANT];e(S,function(w,x){if(w!==sap.ui.fl.condenser.Classification.Destroy){x.forEach(function(y){y.setTargetIndex(y.change,v);y.change.condenserState="select";});}});}});});}function o(r,a){f(a,function(b,c,q,K){var t=q[U.INITIAL_UI];var T=q[U.TARGET_UI];if(m(t,T)){T.forEach(function(v){var w=r[v];if(w!==undefined){e(w[U.INDEX_RELEVANT],function(x,y){y.forEach(function(z){z.change.condenserState="delete";});});delete w[U.INDEX_RELEVANT];}});delete b[K];}});}function p(r,a){f(a,function(b,c,q){var t=q[U.INITIAL_UI];var T=q[U.TARGET_UI];t.forEach(function(v,w){var x=r[v];if(!x||!x[U.INDEX_RELEVANT]){var P=U.PLACEHOLDER+w;var y=T.indexOf(v);if(y>=0){T[y]=P;}}});});}d.swapChanges=function(S,a){var b=S.map(function(c){return a.indexOf(c);}).sort();S.forEach(function(c){a[b.shift()]=c;});};d.sortIndexRelatedChanges=function(a,c){var S=[];var b=g(a,c);f(b,function(A,q,c,r){var t=a[q][r][U.TARGET_UI];var v=a[q][r][U.INITIAL_UI];var w=true;if(i(t)||h(c)){k(c);}else if(!n(q,r,v,t,c)){w=false;var T=c.length;while(T!==0&&!w){var O=0;var N=1;while(N<c.length&&!w){s(c,O,N);w=n(q,r,v,t,c);O++;N++;}T--;}}if(!w){throw Error("no correct sorting found for the container: "+q);}c.forEach(function(x){S=S.concat(x.change);});});return S;};d.addChange=function(a,c){return I[c.classification].addToReconstructionMap(a,c);};d.compareAndUpdate=function(r,a){o(r,a);p(r,a);u(r,a);};return d;});
