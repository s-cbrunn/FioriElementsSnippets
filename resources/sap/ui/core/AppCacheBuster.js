/*!
 * OpenUI5
 * (c) Copyright 2009-2020 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(['sap/ui/base/ManagedObject','./Core','sap/ui/thirdparty/URI','sap/base/Log','sap/base/util/extend','sap/base/strings/escapeRegExp','sap/ui/thirdparty/jquery','sap/ui/core/IconPool'],function(M,C,U,L,a,b,q,I){"use strict";var c=sap.ui.getCore().getConfiguration();var l=c.getLanguage();var s=c.getAppCacheBusterMode()==="sync";var B=c.getAppCacheBusterMode()==="batch";var S={index:{},active:false};var v,d,f,x,E;var g=document.baseURI.replace(/\?.*|#.*/g,"");var u=U(sap.ui.require.toUrl("")+"/../");var o=u.toString();if(u.is("relative")){u=u.absoluteTo(g);}var h=u.normalize().toString();var r=U("resources").absoluteTo(h).toString();var F=new RegExp("^"+b(r));var i=function(e){if(e.length>0&&e.slice(-1)!=="/"){e+="/";}return e;};var R=function(h,e){var m=S.index;var j;var k;var n;if(Array.isArray(h)&&!B){h.forEach(function(J){R(J,e);});}else if(Array.isArray(h)&&B){var p=i(h[0]);var t=[];L.debug("sap.ui.core.AppCacheBuster.register(\""+p+"\"); // BATCH MODE!");var w=A.normalizeURL(p);L.debug("  --> normalized to: \""+w+"\"");h.forEach(function(J){k=i(J);var K=A.normalizeURL(k);if(!m[n]){t.push(K);}});if(t.length>0){var k=w+"sap-ui-cachebuster-info.json?sap-ui-language="+l;j={url:k,type:"POST",async:!s&&!!e,dataType:"json",contentType:"text/plain",data:t.join("\n"),success:function(J){A.onIndexLoaded(k,J);a(m,J);},error:function(){L.error("Failed to batch load AppCacheBuster index file from: \""+k+"\".");}};}}else{h=i(h);L.debug("sap.ui.core.AppCacheBuster.register(\""+h+"\");");n=A.normalizeURL(h);L.debug("  --> normalized to: \""+n+"\"");if(!m[n]){var k=n+"sap-ui-cachebuster-info.json?sap-ui-language="+l;j={url:k,async:!s&&!!e,dataType:"json",success:function(J){A.onIndexLoaded(k,J);m[n]=J;},error:function(){L.error("Failed to load AppCacheBuster index file from: \""+k+"\".");}};}}if(j){var y=A.onIndexLoad(j.url);if(y!=null){L.info("AppCacheBuster index file injected for: \""+k+"\".");j.success(y);}else{if(j.async){var z=e.startTask("load "+k);var D=j.success,G=j.error;Object.assign(j,{success:function(J){D.apply(this,arguments);e.finishTask(z);},error:function(){G.apply(this,arguments);e.finishTask(z,false);}});}L.info("Loading AppCacheBuster index file from: \""+k+"\".");q.ajax(j);}}};var A={boot:function(e){var j=c.getAppCacheBuster();if(j&&j.length>0){j=j.slice();var k=true;var V=String(j[0]).toLowerCase();if(j.length===1){if(V==="true"||V==="x"){var u=U(o);j=u.is("relative")?[u.toString()]:[];}else if(V==="false"){k=false;}}if(k){A.init();R(j,e);}}},init:function(){S.active=true;v=M.prototype.validateProperty;d=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src");f=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href");var j=A.convertURL;var n=A.normalizeURL;var k=function(e){if(this.active===true&&e&&typeof(e)==="string"){e=n(e);return!e.match(F);}return false;}.bind(S);x=XMLHttpRequest.prototype.open;XMLHttpRequest.prototype.open=function(e,w){if(w&&k(w)){arguments[1]=j(w);}x.apply(this,arguments);};E=XMLHttpRequest.prototype.open;M.prototype.validateProperty=function(P,V){var w=this.getMetadata(),y=w.getProperty(P),z;if(y&&y.type==="sap.ui.core.URI"){z=Array.prototype.slice.apply(arguments);try{if(k(z[1])){z[1]=j(z[1]);}}catch(e){}}return v.apply(this,z||arguments);};I._convertUrl=function(e){return j(e);};var m=function(e){var w={get:e.get,set:function(y){if(k(y)){y=j(y);}e.set.call(this,y);},enumerable:e.enumerable,configurable:e.configurable};w.set._sapUiCoreACB=true;return w;};var p=false;try{Object.defineProperty(HTMLScriptElement.prototype,"src",m(d));}catch(t){L.error("Your browser doesn't support redefining the src property of the script tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+t);p=true;}try{Object.defineProperty(HTMLLinkElement.prototype,"href",m(f));}catch(t){L.error("Your browser doesn't support redefining the href property of the link tag. Disabling AppCacheBuster as it is not supported on your browser!\nError: "+t);p=true;}if(p){this.exit();}},exit:function(){M.prototype.validateProperty=v;delete I._convertUrl;if(XMLHttpRequest.prototype.open===E){XMLHttpRequest.prototype.open=x;}var e;if((e=Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype,"src"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLScriptElement.prototype,"src",d);}if((e=Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype,"href"))&&e.set&&e.set._sapUiCoreACB===true){Object.defineProperty(HTMLLinkElement.prototype,"href",f);}S.index={};S.active=false;S={index:{},active:false};},register:function(h){R(h);},convertURL:function(e){L.debug("sap.ui.core.AppCacheBuster.convertURL(\""+e+"\");");var m=S.index;if(m&&e&&!/^#/.test(e)){var n=A.normalizeURL(e);L.debug("  --> normalized to: \""+n+"\"");if(n&&A.handleURL(n)){for(var h in m){var j=m[h],k,p;if(h&&n.length>=h.length&&n.slice(0,h.length)===h){k=n.slice(h.length);p=k.match(/([^?#]*)/)[1];if(j[p]){e=h+"~"+j[p]+"~/"+k;L.debug("  ==> rewritten to \""+e+"\";");break;}}}}}return e;},normalizeURL:function(e){var u=U(e||"./");if(u.is("relative")){u=u.absoluteTo(g);}return u.normalizeProtocol().normalizeHostname().normalizePort().normalizePath().toString();},handleURL:function(e){return true;},onIndexLoad:function(e){return null;},onIndexLoaded:function(e,m){}};var H=c.getAppCacheBusterHooks();if(H){["handleURL","onIndexLoad","onIndexLoaded"].forEach(function(e){if(typeof H[e]==="function"){A[e]=H[e];}});}return A;},true);
